# ----------------------------------------------------------------------------------------------------
# Template to deploy Azure Resources for one environment
# ----------------------------------------------------------------------------------------------------
parameters:
  variableGroupName: 'myVariableGroup'
  environmentName:  'DEV'
  runDateTime: '12-31-2020 23:59:59'

# ----------------------------------------------------------------------------------------------------
jobs:
- deployment: CreateInfra
  displayName: Initialize Create Infra
  environment: ${{ parameters.environmentName }}

- job: CreateInfraJob
  displayName: Create Infrastructure
  variables:
    - group: ${{ parameters.variableGroupName }}
    - name: environmentNameUpper
      value: ${{ upper(parameters.environmentName) }}
    - name: environmentNameLower
      value: ${{ lower(parameters.environmentName) }}
    - name: runDateTime
      value: ${{ parameters.runDateTime }}

  steps:
  - bash: |
      echo "serviceConnectionName=$(serviceConnectionName)"
      echo "subscriptionId=$(subscriptionId)"
      echo "resourceGroupName=$(resourceGroupName)"
      echo "environmentNameUpper=$(environmentNameUpper)"
      echo "environmentNameLower=$(environmentNameLower)"
      echo "location=$(location)"
      echo "orgPrefix=$(orgPrefix)"
      echo "appPrefix=$(appPrefix)"
      echo "appSuffix=$(appSuffix)"
      echo "storageSku=$(storageSku)"
      echo "functionAppSku=$(functionAppSku)"
      echo "functionAppSkuFamily=$(functionAppSkuFamily)"
      echo "functionAppSkuTier=$(functionAppSkuTier)"
      echo "runDateTime=$(runDateTime)"
      echo "bicepDirectory=$(bicepDirectory)"
      echo "bicepFileName=$(bicepFileName)"
    displayName: 'Display Variables'
    continueOnError: true

  # Login is needed if you are pulling Bicep files from an Azure Container Registry
  - task: PowerShell@2
    displayName: 'az login'
    inputs:
      targetType: 'inline'
      script: |
        Write-Host 'Running: az login --service-principal -u $(principalId) -p *** --tenant $(tenantId)'
        az login --service-principal -u $(principalId) -p $(clientSecret) --tenant $(tenantId)

  - script: az bicep build --file $(bicepDirectory)$(bicepFileName) --outfile $(bicepDirectory)compiled.json
    displayName: 'Compile Bicep file'
    continueOnError: true

  - task: AzureResourceManagerTemplateDeployment@3
    displayName: 'Publish Bicep Resources'
    inputs:
      csmFile: $(bicepDirectory)$(bicepFileName)
      overrideParameters: '-environmentCode $(environmentNameLower) -location $(location) -orgPrefix $(orgPrefix) -appPrefix $(appPrefix) -appSuffix $(appSuffix) -storageSku $(storageSku) -functionAppSku $(functionAppSku) -functionAppSkuFamily $(functionAppSkuFamily) -functionAppSkuTier $(functionAppSkuTier)  -keyVaultOwnerUserId1 $(keyVaultOwnerUserId1) -keyVaultOwnerUserId2 $(keyVaultOwnerUserId2) -runDateTime $(runDateTime)'
      deploymentScope: 'Resource Group'
      azureResourceManagerConnection: $(serviceConnectionName)
      subscriptionId: $(subscriptionId)
      action: 'Create Or Update Resource Group'
      resourceGroupName: '$(resourceGroupName)'
      location: '$(location)'
      templateLocation: 'Linked artifact'
      deploymentMode: 'Incremental'
      continueOnError: ignoreError
